---
- hosts: test
  sudo: true
  roles:
    - role: "{{ lookup('pipe','pwd')| dirname }}"
      supervisor_program: testprog
      supervisor_command: > 
        /usr/local/bin/sigtrap.sh 
        "echo -n 'started' > /tmp/status"
        "echo -n 'ended' > /tmp/status"
  post_tasks:
    - service: name=supervisor state=started
      register: superstarted

    - command: supervisorctl start testprog
      register: startcmdoutput
      changed_when: startcmdoutput.stdout.find('already') == -1

    - supervisorctl: name=testprog state=started
      register: modout

    - wait_for: path=/tmp/status search_regex=started

    - command: supervisorctl status testprog
      changed_when: false
      register: processchk

    - name: confirm testprog was already started
      assert:
       that:
         - "'STARTING' in processchk.stdout or 'RUNNING' in processchk.stdout"
#         - "not superstarted.changed | bool"
         - "not startcmdoutput.changed | bool"
         - "not modout.changed | bool"

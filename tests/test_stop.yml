---
- hosts: test
  sudo: true
  roles:
    - role: "{{ lookup('pipe','pwd')| dirname }}"
      supervisor_program: testprog
      supervisor_command: > 
        /usr/local/bin/sigtrap.sh 
        "echo -n 'started' > /tmp/status"
        "echo -n 'ended' > /tmp/status"
  post_tasks:
    - service: name=supervisor state=started
      register: startsuper

    - wait_for: path=/tmp/status search_regex=started
      when: startsuper.changed

    ## if we don't wait long enough for process to be running
    ## process will get sigkilled => we won't see an ended message
    - command: sleep 15
      when: startsuper.changed
      changed_when: false

    - command: supervisorctl stop testprog
      register: startcmdoutput
      changed_when: startcmdoutput.stdout.find('stopped') != -1

    - wait_for: path=/tmp/status search_regex=ended

    - command: supervisorctl status testprog
      changed_when: false
      register: processchk

    - name: confirm testprog is stopped
      assert:
       that:
         - "'STOPPED' in processchk.stdout"
